{{ block content }}

<style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
        }

        .top-block {
            height: 12.5%; /* 1/8 of the page */
            background-color: #f0f0f0; /* Example color */
            text-align: center; /* Center the title */
            padding: 10px;
        }

        .main-content {
            display: flex;
            height: 87.5%; /* Remaining 7/8 of the page */
        }

        .left-block {
            flex: 2; /* 2/5 of the space */
            padding: 10px;
            background-color: #e0e0e0; /* Example color */
        }

        .right-block {
            flex: 3; /* 3/5 of the space */
            display: flex;
            flex-direction: column;
        }

        .offer-table {
            flex: 3; /* Half of the right block */
            padding: 10px;
            background-color: #d0d0d0; /* Example color */
        }

        .accept-table {
            flex: 2; /* Half of the right block */
            padding: 10px;
            background-color: #d0d0d0; /* Example color */
        }

        .chat {
            flex: 5; /* Half of the right block */
            padding: 10px;
            background-color: #c0c0c0; /* Example color */
        }
    </style>

    <div class="top-block">
        <!-- Title -->
        <h1>Experiment: Bargaining</h1>
    </div>

    <div class="main-content">
        <!-- Left Block -->
        <div class="left-block">
            <div style="flex: 1; padding: 10px;">
                <p>
                    You are randomly matched with one participant in the room. You have to decide together how to split the
                    amount of {{ C.PIE_SIZE }} ECU. If you don't find an agreement before the end of the timer, the Player
                    1 will receive [insert a field] ECU and the Player 2 will receive [insert a field] ECU.
                </p>
                <p>
                    You are the {{ player.role }}. Please negotiate with the {{ other_role }} below.
                </p>
            </div>
            <div style="flex: 1; display: flex; padding: 10px;">
                If you fail to find an agreement you will play the following game with your partner.
                In this game you have to simultaneously make a decision. There are 2 options, option A and option B.
                The payoff you will gain depends on your decision and the decision of your partner.
                The possible payoffs are displayed in the following table.
            </div>
        </div>

        <!-- Right Block -->
        <div class="right-block">
            <!-- Offer/Accept Table -->
            <div class="offer-table" style="display: flex;">
                <div style="flex: 1; background-color: #ffddd1;">
                    <table class="table" style="border-color:black; border-style:solid; border-width:1px; border-spacing:0;">
                        <thead>
                            <tr>
                                <th colspan="2">Make a new offer</th>
                                <th colspan="1">Your current offer</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Player 1</td>
                                <td><input type="number" id="my_offer_player1"></td>
                                <td id="my-proposal1">(no offer)</td>
                            </tr>
                            <tr>
                                <td>Player 2</td>
                                <td><input type="number" id="my_offer_player2"></td>
                                <td id="my-proposal2">(no offer)</td>
                            </tr>
                            <tr>
                                <td style="text-align:right" colspan="2"><button type="button" onclick="sendOffer()" id="btn-offer">Send offer</button>
                                <div id="offer-error" style="color: red; display: none;"></div></td>
                                <td><button type="button" onclick="sendCancelOffer()" id="btn-cancel" style="display: none">Cancel offer</button></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="accept-table" style="display: flex;">
                <div style="flex: 1; background-color: #ffddd1;">
                    <table class="table" style="border-color:black; border-style:solid; border-width:1px; border-spacing:0;">
                        <thead>
                            <tr>
                                <th colspan="2">{{ other_role }}'s offer</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Player 1</td>
                                <td id="other-proposal1">(no offer)</td>
                            </tr>
                            <tr>
                                <td>Player 2</td>
                                <td id="other-proposal2">(no offer)</td>
                            </tr>
                            <tr>
                                <td></td>
                                <td><button type="button" id="btn-accept" onclick="sendAccept(this)" style="display: none">Accept</button></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- Chat -->
            <div class="chat">
                <div style="flex: 2; padding: 10px;">
                    <h4>Chat</h4>
                    {{ chat nickname=player.role }}
                </div>
            </div>
        </div>
    </div>


<script>
    let myOfferPlayer1 = document.getElementById('my_offer_player1');
    let myOfferPlayer2 = document.getElementById('my_offer_player2');
    let btnAccept = document.getElementById('btn-accept');
    let msgOtherProposal1 = document.getElementById('other-proposal1');
    let msgOtherProposal2 = document.getElementById('other-proposal2');
    let msgMyProposal1 = document.getElementById('my-proposal1');
    let msgMyProposal2 = document.getElementById('my-proposal2');
    let otherProposalPlayer1;
    let otherProposalPlayer2;

    function sendOffer() {
        let offerPlayer1 = parseInt(myOfferPlayer1.value, 10);
        let offerPlayer2 = parseInt(myOfferPlayer2.value, 10);
        let pieSize = 1000; // Assuming the total pie size is 1000
        let offerError = document.getElementById('offer-error');

        // Check if either input is empty or if their sum exceeds the pie size
        if (isNaN(offerPlayer1) || isNaN(offerPlayer2) || (offerPlayer1 + offerPlayer2) !== pieSize) {
            offerError.textContent = "Invalid offer. Please ensure both fields are filled and the total equals " + pieSize + " points.";
            offerError.style.display = 'block';
            return;
        } else {
            offerError.style.display = 'none';
        }

        liveSend({
            'type': 'propose',
            'amount_player1': offerPlayer1,
            'amount_player2': offerPlayer2
        });
        myOfferPlayer1.value = '';
        myOfferPlayer2.value = '';
    }

    function sendAccept() {
        // Confirmation dialog
        let isConfirmed = confirm("Are you sure you want to accept this offer?");
        if (isConfirmed) {
            // Proceed with the acceptance logic if confirmed
            liveSend({
                'type': 'accept',
                'amount_player1': otherProposalPlayer1,
                'amount_player2': otherProposalPlayer2
            });
        }
        // If cancelled, do nothing
    }

    function sendCancelOffer() {
        // Send a fake offer with values 9999 for both players
        liveSend({
            'type': 'propose',
            'amount_player1': 9999,
            'amount_player2': 9999
        });
        myOfferPlayer1.value = '';
        myOfferPlayer2.value = '';
    }

    function cu(amount) {
        return `${amount} ECU`;
    }

    function liveRecv(data) {
        let pieSize = 1000;
        if ('proposals' in data) {
            for (let [id_in_group, proposalPlayer1, proposalPlayer2] of data.proposals) {
                if (id_in_group === js_vars.my_id) {
                    if (proposalPlayer1 + proposalPlayer2 === pieSize) {
                        msgMyProposal1.innerHTML = `${cu(proposalPlayer1)}`;
                        msgMyProposal2.innerHTML = `${cu(proposalPlayer2)}`;
                        document.getElementById('btn-cancel').style.display = 'block';
                    } else {
                        msgMyProposal1.innerHTML = `(cancelled)`;
                        msgMyProposal2.innerHTML = `(cancelled)`;
                        document.getElementById('btn-cancel').style.display = 'none';
                    }
                } else {
                    if (proposalPlayer1 + proposalPlayer2 === pieSize) {
                        btnAccept.style.display = 'block';
                        msgOtherProposal1.innerHTML = `${cu(proposalPlayer1)}`;
                        msgOtherProposal2.innerHTML = `${cu(proposalPlayer2)}`;
                        otherProposalPlayer1 = proposalPlayer1;
                        otherProposalPlayer2 = proposalPlayer2;
                    } else {
                        btnAccept.style.display = 'none';
                        msgOtherProposal1.innerHTML = `(cancelled)`;
                        msgOtherProposal2.innerHTML = `(cancelled)`;
                        otherProposalPlayer1 = proposalPlayer1;
                        otherProposalPlayer2 = proposalPlayer2;
                    }
                }
            }
        }

        if ('finished' in data) {
            document.getElementById('form').submit();
        }
    }
    window.addEventListener('DOMContentLoaded', (event) => {
        liveSend({});
    });


</script>
{{ endblock }}